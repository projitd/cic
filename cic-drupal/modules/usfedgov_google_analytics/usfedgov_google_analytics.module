<?php

/**
 * @file
 * Adds federal google analytics js to every page load via a select list
 * populated with the .js files in the fed_analytics library directory.
 */

/**
 * grab the settings and return them
 */
function usfedgov_google_analytics_settings() {
  $default_settings = usfedgov_google_analytics_default_settings();
  // @FIXME
  // Could not extract the default value because it is either indeterminate, or
  // not scalar. You'll need to provide a default value in
  // config/install/usfedgov_google_analytics.settings.yml and config/schema/usfedgov_google_analytics.schema.yml.
  $configured_settings = \Drupal::config('usfedgov_google_analytics.settings')->get('usfedgov_google_analytics__settings');
  $configured_settings = empty($configured_settings) ? array() : $configured_settings;
  $settings = array_replace_recursive($default_settings, $configured_settings);
  return $settings;
}

/**
 * Implements hook_page_attachments().
 */
function usfedgov_google_analytics_page_attachments(array &$page) {
  // Allow disabling tracking on specific paths/domains via settings.php.
  if (\Drupal::config('usfedgov_google_analytics.settings')->get('usfedgov_google_analytics__disable')) {
    // Exit hook_init() without adding additional JavaScript.
    return;
  }

  $user = \Drupal::currentUser();
  // Respect Google Analytics module tracking scope settings if that module is
  // enabled.
  if (\Drupal::moduleHandler()->moduleExists('googleanalytics')) {
    if (!_googleanalytics_visibility_pages() || !_googleanalytics_visibility_user($user)) {
      // Exit hook_init() without adding additional JavaScript.
      return;
    }
  }
  if (\Drupal::config('usfedgov_google_analytics.settings')->get('usfedgov_google_analytics__load_from_cdn')) {
    // the admin wants i loaded from the CDN
    $page['#attached']['library'][] = 'usfedgov_google_analytics/load-analytics-cdn';
  }
  else {
    // the user wants it loaded locally
    if (\Drupal::config('usfedgov_google_analytics.settings')->get('usfedgov_google_analytics__load_minified')) {
      $page['#attached']['library'][] = 'usfedgov_google_analytics/load-analytics-local-min';
    }
    else {
      $page['#attached']['library'][] = 'usfedgov_google_analytics/load-analytics-local';
    }
  }

}

/**
 * implements _hook_library_info_build().
 */
function usfedgov_google_analytics_library_info_build() {
  $libraries = array();

  $settings = usfedgov_google_analytics_settings();

  // Move all the keys from the extra subarray into the main array.
  if (!empty($settings)) {
    $defaults = usfedgov_google_analytics_default_settings();
    foreach ($settings['extra'] as $key => $value) {
      // Check to see if this was a boolean selector in the form and make sure
      // it is formatted properly for JS.
      if (is_bool($value)) {
        $value = $value ? 'true' : 'false';
      }
      // make sure we don't add defaults to the settings
      if ($defaults['extra'][$key] != $settings['extra'][$key]) {
        $settings[$key] = $value;
      }
    }
    unset($settings['extra']);
    // Remove any empty keys.
    foreach ($settings as $key => $value) {
      if ($value == "" || $value == NULL) {
        unset($settings[$key]);
      }
    }
  }
  $settings_string = array();
  foreach ($settings AS $key => $value) {
    $settings_string[] = $key . '=' . $value;
  }
  $library = 'js/Universal-Federated-Analytics.js';
  $libraries['load-analytics'] = array(
    'version' => '3.1',
    'js' => array(
      'https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?' . implode('&', $settings_string) => array(
        'type' => 'external',
        'attributes' => array(
          'id' => '_fed_an_ua_tag',
        ),
      ),
    ),
  );
  $libraries['load-analytics-cdn'] = $libraries['load-analytics'];
  $libraries['load-analytics-local'] = array(
    'version' => '3.1',
    'js' => array(
      'js/Universal-Federated-Analytics.js?' . implode('&', $settings_string) => array(
        'attributes' => array(
          'id' => '_fed_an_ua_tag',
        ),
      ),
    ),
  );
  $libraries['load-analytics-local-min'] = array(
    'version' => '3.1',
    'js' => array(
      'js/Universal-Federated-Analytics-Min.js?' . implode('&', $settings_string) => array(
        'attributes' => array(
          'id' => '_fed_an_ua_tag',
        ),
      ),
    ),
  );
  return $libraries;
}

/**
 * returns an array of the default settings
 */
function usfedgov_google_analytics_default_settings() {
  return array(
    'agency' => '',
    'subagency' => '',
    'extra' => array(
      'sp' => NULL,
      'exts' => NULL,
      'yt' => 1,
      'sdor' => 1,
      'dclink' => 0,
      'aip' => 1,
      'pua' => NULL,
      'enhlink' => 0,
      'autotracker' => 1,
      'forcessl' => 0,
      'optout' => 0,
      'fedagencydim' => NULL,
      'fedsubagencydim' => NULL,
      'fedversiondim' => NULL,
      'palagencydim' => NULL,
      'palsubagencydim' => NULL,
      'palversiondim' => NULL,
      'maincd' => 1,
      'parallelcd' => 0,
      'cto' => NULL,
    ),
  );
}

/**
 * Implements hook_permission().
 */
function usfedgov_google_analytics_permission() {
  return array(
    'administer federal google analytics' => array(
      'title'           => t('Administer Federal Google Analytics'),
      'restrict access' => TRUE,
    ),
  );
}
